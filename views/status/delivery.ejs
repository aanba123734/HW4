<!DOCTYPE html>
<html>
<head>
    <title>Delivery Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container mt-4">
        <h2>Delivery Status Management</h2>
        
        <div class="status-box mb-4">
            <form action="/status/delivery" method="GET" class="row align-items-end">
                <div class="col-md-3">
                    <label>Material Code / PO No.</label>
                    <input type="text" name="search" class="form-control border-dark rounded-pill" placeholder="80000123">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-retro rounded-pill w-100">SEARCH</button>
                </div>
            </form>
        </div>

        <table class="table table-bordered border-dark table-retro align-middle text-center">
            <thead>
                <tr>
                    <th>PO No.</th>
                    <th>Material Code</th>
                    <th>Status</th>
                    <th>Update Date</th>
                    <th style="width: 150px;">Actions</th> </tr>
            </thead>
            <tbody>
                <% if (deliveries.length === 0) { %>
                    <tr><td colspan="5" class="text-center">No Data Found</td></tr>
                <% } %>
                <% deliveries.forEach(d => { %>
                    <tr>
                        <td><strong><%= d.po_number %></strong></td>
                        <td><%= d.material_code %></td>
                        <td>
                            <% if(d.status === 'On Track') { %>
                                <span class="badge bg-warning text-dark">On Track</span>
                            <% } else if (d.status === 'Late') { %>
                                <span class="badge bg-danger">Late</span>
                            <% } else if (d.status === 'Delivered') { %>
                                <span class="badge bg-success">Delivered</span>
                            <% } else if (d.status === 'Cancelled') { %>
                                <span class="badge bg-secondary">Cancelled</span>
                            <% } else { %>
                                <span class="badge bg-light text-dark border"><%= d.status %></span>
                            <% } %>
                        </td>
                        <td><%= d.updated_at.toISOString().split('T')[0] %></td>
                        <td>
                            <a href="/status/delivery/<%= d.id %>" class="btn btn-sm btn-outline-dark me-1" title="View Details">
                                <i class="bi bi-eye"></i> View
                            </a>
                            <a href="/status/delivery/<%= d.id %>/edit" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <form action="/status/delivery/<%= d.id %>?_method=DELETE" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this record?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i> Del
                                </button>
                            </form>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const msg = urlParams.get('msg');

        if (success === 'true') {
            Swal.fire({
                icon: 'success',
                title: 'Done!',
                text: msg,
                confirmButtonColor: '#8A2BE2'
            }).then(() => {
                window.history.replaceState({}, document.title, "/status/delivery");
            });
        }
    </script>
</body>
</html>